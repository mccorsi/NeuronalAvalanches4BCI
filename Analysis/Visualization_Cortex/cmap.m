function [rgb]=cmap(x, mapName, greyPerc, grayColor, grayFunction, greyPosition)
% [rgb]=cmap(x, mapName);
% [rgb]=cmap(mapName);
% [rgb]=cmap(x, mapName, greyExt, grayColor, grayFunction, greyPosition)

% TODO se il primo argomento di ingresso non ? una matrice numerica, scalare i successivi parametri in
% modo da ammettere la sintassi cmap('hot', []

if nargin<6 | isempty(greyPosition)
    greyPosition='center'; % 'bottom' 'center' 'top'
end% if

if nargin<5 | isempty(grayFunction)
    grayFunction='gauss'; % 'flat' 'linear' 'gauss'
end% if

if nargin<4 | isempty(grayColor)
    grayColor=[.5 .5 .5];
end% if

if nargin<3 | isempty(greyPerc)
    greyPerc=0; % extention of the grey part of the palette (half-width)
end% if

if nargin<2 | isempty(mapName)
    mapName='iris';
end% if

if nargin<1 | ischar(x)
    if ischar(x)
        mapName=x;
    end% if
    x=size(get(gcf,'colormap'),1);
elseif prod(size(x))==1 & x==floor(x) & x>1
    nSteps=x;
    x=linspace(0, 1, nSteps);
end% if

if prod(size(x))==1 & x>1 & x==floor(x)
    paletteLength=x;
    x=linspace(0, 1, paletteLength)';
end% if

x=x(:);
if any(x<0 | x>1)
    orgX=x;
    x(orgX<0)=0;
    x(orgX>1)=1;
    warning ('CMAP - some data fall outside the [0 1] range!')
end% if
%
nanNdcs=isnan(x);
if sum(nanNdcs)
    nanX=x;
    x(nanNdcs)=[];
end% if


BySample=0;
switch lower(mapName)
    
    %-----------aggiunto da marie-constance corsi
    case 'summer'
        ri=[0, 0.4921, 1]';
        gi=[0.5, 0.746,1]';
        bi=[0.4, 0.4,0.4]';
        BySample=1;        
        
        
    case 'spectral'
        ri=[158/256,255/256,94/256]';
        gi=[1/256,255/256,79/256]';
        bi=[66/256,191/256,162/256]';
        BySample=1;
        
   case '*spectral'
        ri=[94/256,255/256,158/256]';
        gi=[79/256,255/256,1/256]';
        bi=[162/256,191/256,66/256,]';
        BySample=1;
        
    case 'blues'
        ri=[247/256,107/256,8/256]';
        gi=[251/256,174/256,48/256]';
        bi=[255/256,214/256,107/256]';
        BySample=1;
        
    case '*blues'
        ri=[8/256,107/256,247/256]';
        gi=[48/256,174/256,251/256]';
        bi=[107/256,214/256,255/256]';
        BySample=1;
        
    case '*blues_gray'
        ri=[8/256,107/256,0.81]';
        gi=[48/256,174/256,0.81]';
        bi=[107/256,214/256,0.81]';
        BySample=1;
        
    case 'blues_gray_mcc'
        ri=[0.81,107/256,8/256]';
        gi=[0.81,174/256,48/256]';
        bi=[0.81,214/256,107/256]';
        BySample=1;
        
    case 'reds_mcc'    
        ri=[255/256,251/256,103/256]';
        gi=[245/256,106/256,0/256]';
        bi=[240/256,74/256,13/256]';
        BySample=1;
        
   case '*reds_mcc'    
        ri=[103/256,251/256,255/256]';
        gi=[0/256,106/256,245/256,]';
        bi=[13/256,74/256,240/256]';
        BySample=1;    
        
    case 'rdblu'
        ri=[247/256 8/256 227/256 247/256]';
        gi=[247/256 69/256 26/256 247/256]';
        bi=[247/256 148/256 28/256 247/256]';
        BySample=1;
        
    case 'francia'
        ri=[8/256 247/256 227/256]';
        gi=[69/256 247/256 26/256]';
        bi=[148/256 247/256 28/256]';
        BySample=1;
        
    case 'rdblu_gray'
        ri=[8/256 0.81 210/256]';
        gi=[48/256 0.81 12/256]';
        bi=[107/256 0.81 8/256]';
        BySample=1;
        
    case 'rdblu_gray_mcc'
        ri=[0.81 8/256 0.81 210/256 0.81]';
        gi=[0.81 48/256 0.81 12/256 0.81]';
        bi=[0.81 107/256 0.81 8/256 0.81]';
        BySample=1;    
        
    case'rdblu_strong'
        ri=[247/256;0.556900000000000;0.541900000000000;0.527000000000000;0.512100000000000;0.497200000000000;0.482200000000000;0.467300000000000;0.452400000000000;0.437400000000000;0.422500000000000;0.407600000000000;0.392700000000000;0.377700000000000;0.362800000000000;0.347900000000000;0.333000000000000;0.318000000000000;0.303100000000000;0.288200000000000;0.273200000000000;0.258300000000000;0.243400000000000;0.228500000000000;0.213500000000000;0.198600000000000;0.183700000000000;0.168800000000000;0.153800000000000;0.138900000000000;0.124000000000000;0.109000000000000;0.0941000000000000;0.392200000000000;0.411800000000000;0.431400000000000;0.451000000000000;0.470600000000000;0.490200000000000;0.509800000000000;0.529400000000000;0.549000000000000;0.568600000000000;0.588200000000000;0.607800000000000;0.627500000000000;0.647100000000000;0.666700000000000;0.686300000000000;0.705900000000000;0.725500000000000;0.745100000000000;0.764700000000000;0.784300000000000;0.803900000000000;0.823500000000000;0.843100000000000;0.862700000000000;0.882400000000000;0.902000000000000;0.921600000000000;0.941200000000000;0.960800000000000;0.980400000000000;1;247/256];
        gi=[247/256;0.792200000000000;0.774700000000000;0.757200000000000;0.739800000000000;0.722300000000000;0.704900000000000;0.687400000000000;0.670000000000000;0.652500000000000;0.635000000000000;0.617600000000000;0.600100000000000;0.582700000000000;0.565200000000000;0.547800000000000;0.530300000000000;0.512800000000000;0.495400000000000;0.477900000000000;0.460500000000000;0.443000000000000;0.425600000000000;0.408100000000000;0.390600000000000;0.373200000000000;0.355700000000000;0.338300000000000;0.320800000000000;0.303400000000000;0.285900000000000;0.268400000000000;0.251000000000000;0;0.00370000000000000;0.00730000000000000;0.0110000000000000;0.0147000000000000;0.0183000000000000;0.0220000000000000;0.0257000000000000;0.0293000000000000;0.0330000000000000;0.0367000000000000;0.0404000000000000;0.0440000000000000;0.0477000000000000;0.0514000000000000;0.0550000000000000;0.0587000000000000;0.0624000000000000;0.0660000000000000;0.0697000000000000;0.0734000000000000;0.0770000000000000;0.0807000000000000;0.0844000000000000;0.0880000000000000;0.0917000000000000;0.0954000000000000;0.0991000000000000;0.102700000000000;0.106400000000000;0.110100000000000;0.113700000000000;247/256];
        bi=[247/256;1;0.980400000000000;0.960800000000000;0.941200000000000;0.921600000000000;0.902000000000000;0.882400000000000;0.862700000000000;0.843100000000000;0.823500000000000;0.803900000000000;0.784300000000000;0.764700000000000;0.745100000000000;0.725500000000000;0.705900000000000;0.686300000000000;0.666700000000000;0.647100000000000;0.627500000000000;0.607800000000000;0.588200000000000;0.568600000000000;0.549000000000000;0.529400000000000;0.509800000000000;0.490200000000000;0.470600000000000;0.451000000000000;0.431400000000000;0.411800000000000;0.392200000000000;0;0.00230000000000000;0.00460000000000000;0.00680000000000000;0.00910000000000000;0.0114000000000000;0.0137000000000000;0.0159000000000000;0.0182000000000000;0.0205000000000000;0.0228000000000000;0.0250000000000000;0.0273000000000000;0.0296000000000000;0.0319000000000000;0.0342000000000000;0.0364000000000000;0.0387000000000000;0.0410000000000000;0.0433000000000000;0.0455000000000000;0.0478000000000000;0.0501000000000000;0.0524000000000000;0.0546000000000000;0.0569000000000000;0.0592000000000000;0.0615000000000000;0.0638000000000000;0.0660000000000000;0.0683000000000000;0.0706000000000000;247/256];
        BySample=1;
        
    case 'hot_mcc'
        ri=[0.501961000000000;0.525677000000000;0.549393000000000;0.573109000000000;0.596825000000000;0.620542000000000;0.644258000000000;0.667974000000000;0.691690000000000;0.715406000000000;0.739122000000000;0.762838000000000;0.786555000000000;0.810271000000000;0.833987000000000;0.857703000000000;0.881419000000000;0.905135000000000;0.928852000000000;0.952568000000000;0.976284000000000;1;1;1;1;1;1;1;1;1;1;1;1;1;1;1;1;1;1;1;1;1;1;1;1;1;1;1;1;1;1;1;1;1;1;1;1;1;1;1;1;1;1;1];
        gi=[0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0.0434780000000000;0.0869570000000000;0.130435000000000;0.173913000000000;0.217391000000000;0.260870000000000;0.304348000000000;0.347826000000000;0.391304000000000;0.434783000000000;0.478261000000000;0.521739000000000;0.565217000000000;0.608696000000000;0.652174000000000;0.695652000000000;0.739130000000000;0.782609000000000;0.826087000000000;0.869565000000000;0.913043000000000;0.956522000000000;1;1;1;1;1;1;1;1;1;1;1;1;1;1;1;1;1;1;1;1];
        bi=[0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0.0526320000000000;0.105263000000000;0.157895000000000;0.210526000000000;0.263158000000000;0.315789000000000;0.368421000000000;0.421053000000000;0.473684000000000;0.526316000000000;0.578947000000000;0.631579000000000;0.684211000000000;0.736842000000000;0.789474000000000;0.842105000000000;0.894737000000000;0.947368000000000;1];
        BySample=1;
		
    case 'accent_mcc'
        ri=[0.498039215686275;0.745098039215686;0.992156862745098;1;0.219607843137255;0.941176470588235;0.749019607843137;0.400000000000000;0.498039215686275;0.745098039215686;0.992156862745098;1;0.219607843137255;0.941176470588235;0.749019607843137;0.400000000000000;0.498039215686275;0.745098039215686;0.992156862745098;1;0.219607843137255;0.941176470588235;0.749019607843137;0.400000000000000;0.498039215686275;0.745098039215686;0.992156862745098;1;0.219607843137255;0.941176470588235;0.749019607843137;0.400000000000000;0.498039215686275;0.745098039215686;0.992156862745098;1;0.219607843137255;0.941176470588235;0.749019607843137;0.400000000000000;0.498039215686275;0.745098039215686;0.992156862745098;1;0.219607843137255;0.941176470588235;0.749019607843137;0.400000000000000;0.498039215686275;0.745098039215686;0.992156862745098;1;0.219607843137255;0.941176470588235;0.749019607843137;0.400000000000000;0.498039215686275;0.745098039215686;0.992156862745098;1;0.219607843137255;0.941176470588235;0.749019607843137;0.400000000000000];
        gi=[0.788235294117647;0.682352941176471;0.752941176470588;1;0.423529411764706;0.00784313725490196;0.356862745098039;0.400000000000000;0.788235294117647;0.682352941176471;0.752941176470588;1;0.423529411764706;0.00784313725490196;0.356862745098039;0.400000000000000;0.788235294117647;0.682352941176471;0.752941176470588;1;0.423529411764706;0.00784313725490196;0.356862745098039;0.400000000000000;0.788235294117647;0.682352941176471;0.752941176470588;1;0.423529411764706;0.00784313725490196;0.356862745098039;0.400000000000000;0.788235294117647;0.682352941176471;0.752941176470588;1;0.423529411764706;0.00784313725490196;0.356862745098039;0.400000000000000;0.788235294117647;0.682352941176471;0.752941176470588;1;0.423529411764706;0.00784313725490196;0.356862745098039;0.400000000000000;0.788235294117647;0.682352941176471;0.752941176470588;1;0.423529411764706;0.00784313725490196;0.356862745098039;0.400000000000000;0.788235294117647;0.682352941176471;0.752941176470588;1;0.423529411764706;0.00784313725490196;0.356862745098039;0.400000000000000];
        bi=[0.498039215686275;0.831372549019608;0.525490196078431;0.600000000000000;0.690196078431373;0.498039215686275;0.0901960784313726;0.400000000000000;0.498039215686275;0.831372549019608;0.525490196078431;0.600000000000000;0.690196078431373;0.498039215686275;0.0901960784313726;0.400000000000000;0.498039215686275;0.831372549019608;0.525490196078431;0.600000000000000;0.690196078431373;0.498039215686275;0.0901960784313726;0.400000000000000;0.498039215686275;0.831372549019608;0.525490196078431;0.600000000000000;0.690196078431373;0.498039215686275;0.0901960784313726;0.400000000000000;0.498039215686275;0.831372549019608;0.525490196078431;0.600000000000000;0.690196078431373;0.498039215686275;0.0901960784313726;0.400000000000000;0.498039215686275;0.831372549019608;0.525490196078431;0.600000000000000;0.690196078431373;0.498039215686275;0.0901960784313726;0.400000000000000;0.498039215686275;0.831372549019608;0.525490196078431;0.600000000000000;0.690196078431373;0.498039215686275;0.0901960784313726;0.400000000000000;0.498039215686275;0.831372549019608;0.525490196078431;0.600000000000000;0.690196078431373;0.498039215686275;0.0901960784313726;0.400000000000000];
        BySample=1;
        
    case 'mod_mcc'
        ri=[0.552941176470588;1;0.745098039215686;0.984313725490196;0.501960784313726;0.992156862745098;0.701960784313725;0.988235294117647;0.850980392156863;0.737254901960784;0.800000000000000;1;0.498039215686275;0.745098039215686;0.992156862745098;1;0.219607843137255;0.941176470588235;0.749019607843137;0.400000000000000;0.105882352941176;0.850980392156863;0.458823529411765;0.905882352941177;0.400000000000000;0.901960784313726;0.650980392156863;0.400000000000000];
        gi=[0.827450980392157;1;0.729411764705882;0.501960784313726;0.694117647058824;0.705882352941177;0.870588235294118;0.803921568627451;0.850980392156863;0.501960784313726;0.921568627450980;0.929411764705882;0.788235294117647;0.682352941176471;0.752941176470588;1;0.423529411764706;0.00784313725490196;0.356862745098039;0.400000000000000;0.619607843137255;0.372549019607843;0.439215686274510;0.160784313725490;0.650980392156863;0.670588235294118;0.462745098039216;0.400000000000000];
        bi=[0.780392156862745;0.701960784313725;0.854901960784314;0.447058823529412;0.827450980392157;0.384313725490196;0.411764705882353;0.898039215686275;0.850980392156863;0.741176470588235;0.772549019607843;0.435294117647059;0.498039215686275;0.831372549019608;0.525490196078431;0.600000000000000;0.690196078431373;0.498039215686275;0.0901960784313726;0.400000000000000;0.466666666666667;0.00784313725490196;0.701960784313725;0.541176470588235;0.117647058823529;0.00784313725490196;0.113725490196078;0.400000000000000];
        BySample=1;
        
        
    case 'hotnorm_mcc'
        ri=[1 1 1 0.39]';%0
        gi=[1 1 .5 0.15]';%0
        bi=[1 0.25 0 0.15]'; %0      
        %
        BySample=1;
        
    %-----------aggiunto da fabrizio de vico fallani
    
    case 'wyr'
        ri=[1  1  .75 ]';
        gi=[1  1  0 ]';
        bi=[1  0  0  ]';
        
        BySample=1;
        
    case 'fluo'
        ri=[0 .25  .75 1]';
        gi=[0  .5  1 1]';
        bi=[0  0  0 1]';
        
        BySample=1;
        
    case 'r2y'
        ri=[0.4  1]';
        gi=[0  1]';
        bi=[0  0]';
        
        BySample=1;
        
    case 'spm2'
        ri=[1  0  0  0 .66  1 1  1  1]';
        gi=[1  1  .66  0 .66  0 .66  1 1]';
        bi=[1  1  1  1  .66  0 0  0  1]';
        
        BySample=1;
        
    case 'spm3'
        ri=[1  0  0  1  1  1]';
        gi=[1  1  0  0  1  1]';
        bi=[1  1  1  0  0  1]';
        
        BySample=1;
        
    case 'spm6'
        ri=[.75  0  0  1  1  .75]';
        gi=[.75  1  0  0  1  .75]';
        bi=[.75  1  1  0  0  .75]';
        
        BySample=1;
        
            case 'spm7'
        ri=[.5  .5  .25  1  .75  .5]';
        gi=[.5  .5  .25  .25  .25  .5]';
        bi=[.5  .75  1  .25  .25  .5]';
        
        BySample=1;
        
    case 'spm4'
        ri=[ 1  1  1]';
        gi=[ 0  1  1]';
        bi=[ 0  0  1]';
        
        BySample=1;
        
    case 'spm5'
        ri=[1  0  0  ]';
        gi=[1  1  0  ]';
        bi=[1  1  1  ]';
        
        BySample=1;
        
        
    case 'spm'
        ri=[.5  1 1  1  1]';
        gi=[.5  0 .5  1 1]';
        bi=[.5  0 0  0  1]';
        
        BySample=1;
    case 'bgr'
        ri=[0 0 .5 1 1]';
        gi=[0 1 .5 0 1]';
        bi=[1 1 .5 0 0]';
        
        BySample=1;
        
    case 'hyper'
        ri=[0 0 1 0 1]';
        gi=[0 0 0 1 1]';
        bi=[0 1 0 0 1]';
        
        BySample=1;
        
    case 'hyperinv'
        ri=[1 0 1 0 0]';
        gi=[1 1 0 0 0]';
        bi=[1 0 0 1 0]';
        
        BySample=1;
        
    case 'yellow'
        ri=[.5 .75 .1]';
        gi=[.5 .75 1]';
        bi=[0 .25 .5]';
        
        BySample=1;
        
    case 'jet'
        colmat=colormap(jet(64));
        ri=colmat(:,1);
        gi=colmat(:,2);
        bi=colmat(:,3);
        %
        
        BySample=1;
        
    case 'rgreenb'
        ri=[0 0 1]';
        gi=[0 1 0]';
        bi=[1 0 0]';
        
        BySample=1;
        
    case 'rgrayb'
        ri=[0 .7 1]';
        gi=[0 .7 0]';
        bi=[1 .7 0]';
        
        BySample=1;
        
    case 'jetwhite'
        ri=[ .0   0   0   1   1   1  .5]';
        gi=[ .0   .5  1   1   .5  0   0]';
        bi=[ 1    1   1   1   0   0   0]';
        
        
        BySample=1;
        
        %------------------------------------------------
        
    case 'hot'
        ri=[0.0 0.7 1.0]';
        gi=[0.0 0.0 1.0]';
        bi=[0.0 0.0 0.0]';
        %
        BySample=1;
    case 'hotinv'
        ri=[1 0 0]';
        gi=[1 1 0]';
        bi=[1 0 0]';
        %
        BySample=1;
    case 'hotnorm'
        ri=[0 1 1]';
        gi=[0 .5 1]';
        bi=[0 0 .25]';
        %
        BySample=1;
    case 'jet2'
        ri=[0 .66 .99]';
        gi=[.33 0 .99]';
        bi=[.66 0 0]';
        %
        BySample=1;
    case 'cold'
        ri=[0.0 0.0 0.0]';
        gi=[0.0 0.0 1.0]';
        bi=[0.0 0.7 1.0]';
        %
        BySample=1;
    case 'temperature'
        ri=[0.0 0.0 0.5 0.7 1.0]';
        gi=[1.0 0.0 0.5 0.0 1.0]';
        bi=[1.0 0.7 0.5 0.0 0.0]';
        %
        BySample=1;
    case 'reds'
        ri=[1  .9   .8 .7  .6]';
        gi=[.9 .8  .7   .6  .5]';
        bi=[0 0   0  0   0]';
        %
        BySample=1;
        
    case 'div'
        ri=[.1686 1 .9882]';
        gi=[ 0.4490 1 .1529 ]';
        bi=[ 0.8588 0.7490 0.0490]';
        %
        BySample=1;
        
    case 'div2'
        ri=[.5686 1 .9882]';
        gi=[ 0.7490 1 .5529 ]';
        bi=[ 0.8588 0.7490 0.3490]';
        %
        BySample=1;
        
    case 'soft'
        r=x;
        g=x; g(:)=1;
        b=1-x;
        rgb=[r g b];
    case {'iris' '+iris' '-iris'}
        ri=[0.0 0.4 0.0 0.0 0.0 0.8 1.0 0.7 1.0]';
        gi=[0.0 0.0 0.0 0.8 1.0 0.8 0.0 0.3 1.0]';
        bi=[0.0 0.8 1.0 0.8 0.0 0.0 0.0 0.5 1.0]';
        
        %ri=[1.0 0.8 1.0 0.8 0.0 0.0 0.0 0.4 0.0]';
        %gi=[1.0 0.2 0.0 0.8 1.0 0.8 0.0 0.0 0.0]';
        %bi=[1.0 0.5 0.0 0.0 0.0 0.8 1.0 0.8 0.0]';
        %
        BySample=1;
    case {'luigi' '+luigi' '-luigi' }
        %ri=[0.0 0.7 1.0]';
        %gi=[0.0 0.7 0.0]';
        %bi=[1.0 0.7 0.0]';
        ri=[0.8  0.0  0.5 0.7 1.0]';
        gi=[0.7 0.0  0.5 0.7 1.0]';
        bi=[0.7 0.0  0.5 0.7 1.0]';
        %
        BySample=1;
    case {'luigi1' '+luigi1' '-luigi1' }
        ri=[0 0.2  0.8 0.7 1.0]';
        gi=[0 0.2  0.7 0.7 1.0]';
        bi=[0 0.2  0.7 0.7 1.0]';
        %
        BySample=1;
    case 'hsv'
        h=x;
        sv=x; sv(:)=1;
        rgb=hsv2rgb([h sv sv]);
    case '-hsv'
        h=1-x;
        sv=x; sv(:)=1;
        rgb=hsv2rgb([h sv sv]);
    case 'gray'
        rgb=x(:, [1 1 1]);
    case '-gray'
        rgb=1-x(:, [1 1 1]);
    case 'bluescale'
        ri=[.8 0]';
        gi=[.8 0]';
        bi=[1  1]';
        %
        BySample=1;
        
    case 'greyinv'
        ri=[1 .5 0]';
        gi=[1 .5 0]';
        bi=[1 .5 0]';
        %
        BySample=1;
        
    case 'grey'
        ri=[0 .5 1]';
        gi=[0 .5 1]';
        bi=[0 .5 1]';
        %
        BySample=1;
        
    case 'wr'
        ri=[1 1  1  .5]';
        gi=[1 .75 .5  0]';
        bi=[1 .75 .5  0 ]';
        %
        BySample=1;
        
    case 'wb'
        ri=[1 .75 .5 0]';
        gi=[1 .75 .5 0]';
        bi=[1 1 1 .5]';
        %
        BySample=1;
        
    case 'br'
        ri=[0   0   .5  1   .75]';
        gi=[.25 .5  1   .5  .25]';
        bi=[.75 1   .5  0   0]';
        %
        BySample=1;
        
        
    otherwise
        rgb=x(:, [1 1 1]); % gray
end% switch

if BySample
    nInt=length(ri)-1;
    if mapName(1)=='-'
        xx=(1-x)*nInt;
    else
        xx=x*nInt;
    end% if
    
    xxfloor=floor(xx)-(xx==nInt);
    xxceil=xxfloor+1;
    xxrem=xx-xxfloor;
    rgb = [ ...
        ri(xxfloor+1) + xxrem .* (ri(xxceil+1)-ri(xxfloor+1)), ...
        gi(xxfloor+1) + xxrem .* (gi(xxceil+1)-gi(xxfloor+1)), ...
        bi(xxfloor+1) + xxrem .* (bi(xxceil+1)-bi(xxfloor+1)) ...
        ];

end% if BySample

if greyPerc~=0
    switch greyPosition
        case 'bottom'
            greyExt=[0 0 greyPerc];
        case 'center'
            greyExt=.5+[-greyPerc 0 +greyPerc];
        case 'top'
            greyExt=1-[greyPerc 0 0];
    end% switch
    rgbSat=rgb;
    rgbGrey=repmat(grayColor, [size(rgbSat, 1) 1]);
    switch(grayFunction)
        case 'flat'
            blend=[x>greyExt(1) & x<greyExt(3)];
            rgb= (1-blend(:, [1 1 1])).*rgbSat + blend(:, [1 1 1]).*rgbGrey;
        case 'linear'
            blend= ...
                (x>greyExt(1) & x<greyExt(2)) * ( x-greyExt(1)/(greyExt(2)-greyExt(1))) + ...
                (x>greyExt(2) & x<greyExt(3)) * ( greyExt(3)-x/(greyExt(3)-greyExt(2)))  ...
                ;
            rgb= (1-blend(:, [1 1 1])).*rgbSat + blend(:, [1 1 1]).*rgbGrey;
        case 'gauss'
            blend=exp( ...
                -(x-greyExt(2)).^2 / ...
                ( 2*(greyExt(2)-greyExt(1)).^2 ) ...
                );
            rgb= (1-blend(:, [1 1 1])).*rgbSat + blend(:, [1 1 1]).*rgbGrey;
        case 'threshold1'
            blend=[x>greyExt(1) & x<greyExt(3)];
            
        case 'threshold2'
            blendpos=[x>=greyExt(3)];
            valpos=x(find(blendpos));
            norvalpos=(valpos-min(valpos))./(max(valpos)-min(valpos));
            if length(valpos)
                colpos=cmap(norvalpos,'spm4');
            else
                colpos=[];
            end
            
            blendneg=[x<=greyExt(1)];
            valneg=x(find(blendneg));
            norvalneg=(valneg-min(valneg))./(max(valneg)-min(valneg));
            if length(valneg)
                colneg=cmap(norvalneg,'spm5');
            else
                colneg=[];
            end
            
            
            rgb=repmat(grayColor,size(x,1),1);
            
            if ~isempty(colpos)
                rgb(find(blendpos),:)=colpos;
            end
            if ~isempty(colneg)
                rgb(find(blendneg),:)=colneg;
            end
            
            
            
            
    end% switch
    
end% if greyPerc

if sum(nanNdcs)
    noNanRgb=rgb;
    rgb=nan*zeros([length(nanNdcs) 3]);
    rgb(~nanNdcs, :)=noNanRgb;
end% if

